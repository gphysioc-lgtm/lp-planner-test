<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CL LP Exposure Planner — Capital Deployment</title>
<style>
  :root {
    --bg:#0b0f14; --card:#101620; --ink:#e8eef6; --muted:#9fb1c7;
    --accent:#5bb0ff; --good:#17c964; --bad:#ff5d5d; --warn:#ffc857;
    --highlight:#334255; --purple:#e08aff;
  }
  * { box-sizing:border-box; }
  body {
    margin:0; font:13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    background:var(--bg); color:var(--ink);
  }
  header {
    padding:16px 18px; border-bottom:1px solid #17202d;
    position:sticky; top:0;
    background:linear-gradient(180deg,#0b0f14,#0b0f14f2 70%,transparent);
    z-index:5;
    display:flex; justify-content:space-between; align-items:center;
  }
  h1 { margin:0; font-size:15px; letter-spacing:.3px; font-weight:600; }
  
  /* TABS */
  .tab-nav { display:flex; gap:4px; background:#101620; padding:4px; border-radius:8px; border:1px solid #1a2433; }
  .tab-btn {
      background:transparent; border:none; color:var(--muted); 
      padding:6px 12px; font-size:12px; font-weight:600; cursor:pointer; border-radius:6px;
  }
  .tab-btn:hover { color:var(--ink); background:#1a2433; }
  .tab-btn.active { background:var(--accent); color:#000; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  .wrap { padding:16px 18px 36px; max-width:2000px; margin:0 auto; }
  .layout-grid { display:grid; grid-template-columns:1.15fr 1fr; gap:14px; align-items:start; }
  
  .card {
    background:var(--card); border:1px solid #17202d; border-radius:16px;
    padding:14px; box-shadow:0 4px 24px rgba(0,0,0,.25); margin-bottom: 14px;
  }
  .card h2 { margin:0 0 8px; font-size:13px; font-weight:600; color:var(--ink); }
  label { display:block; color:var(--muted); font-size:11px; margin:6px 0 3px; }
  input[type=number], select, input[type=text] {
    width:100%; padding:8px 10px; border:1px solid #233142;
    border-radius:10px; background:#0c121a; color:var(--ink); outline:none;
    -webkit-appearance: none; -moz-appearance: textfield;
  }
  input[readonly] { background: var(--highlight); color: var(--accent); }
  
  .chk-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
  input[type=checkbox] { width:auto; transform:scale(1.2); cursor:pointer; }
  
  .row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
  .row2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .row4 { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .btns { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;}
  
  button {
    padding:8px 10px; border:1px solid #223146; background:#0e1621;
    color:var(--ink); border-radius:12px; cursor:pointer; transition:.15s ease;
  }
  button.primary { background:linear-gradient(180deg,#1b2c43,#142133); border-color:#2d4666; }
  button.secondary { background: #1a2a3d; border-color: #2d4666; color: #a7c4e6; }
  button.secondary:hover { background: #23364d; }
  button.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
  button.purple { border-color:#5c2d66; color:#e08aff; background:linear-gradient(180deg,#28152e,#1a0e1f); }
  button.purple:hover { background:#381d40; }

  .muted { color:var(--muted); font-size:11px; }
  .pill {
    display:inline-block; padding:3px 7px; border-radius:999px;
    border:1px solid #26415f; background:#0f1723;
    font-size:10px; color:#a7c4e6;
  }
  table { width:100%; border-collapse:separate; border-spacing:0; min-width:1400px; table-layout:auto; }
  th, td { padding:6px 8px; border-bottom:1px solid #1a2433; text-align:right; white-space:nowrap; }
  th { position:sticky; top:0; background:#0f1622; z-index:2; font-weight:600; color:#b9cbe0; white-space:normal; line-height:1.2; }
  th:first-child, td:first-child { text-align:left; position:sticky; left:0; background:linear-gradient(90deg,#0f1622,#0f1622cc); z-index:1; }
  .scroll { overflow:auto; border:1px solid #17202d; border-radius:14px; max-height:60vh; }
  
  .footnote { margin-top:8px; font-size:11px; color:#95a9c2; }
  .tag { display:inline-block; font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid #284d6f; background:#0d1a27; }
  .tag.hold { border-color:#2a6f4d; background:#0d2017; }
  .tag.source { border-color:#6f2a2a; background:#27100f; }
  
  .section-header { margin: 24px 0 12px; font-size: 16px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #17202d; padding-bottom: 8px; }
  .summary-box { padding: 12px; background: #0e1622; border: 1px solid #1a2a3d; border-radius: 12px; margin-bottom: 14px; display: flex; flex-direction: column; gap: 12px; }
  .summary-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding-bottom: 8px; border-bottom: 1px solid #1a2433; }
  .summary-row:last-child { border-bottom: none; padding-bottom: 0; }
  .summary-item label { color: var(--muted); font-size: 10px; text-transform: uppercase; margin:0 0 2px 0; display:block;}
  .summary-item div { font-size: 13px; font-weight: 600; color: var(--ink); }
  
  /* Cross Pair Styles */
  .cp-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:12px; }
  .cp-card { background:#161d2b; padding:16px; border-radius:12px; border:1px solid #233142; }
  .cp-val { font-family:monospace; color:var(--accent); font-size:14px; font-weight:600; margin-top:2px; }
  .cp-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
  .rec-box { background:linear-gradient(90deg, #16241a, #0e1621); border:1px solid #1c693b; padding:16px; border-radius:12px; margin-top:16px; }
  
  #debugBox { margin-top: 10px; padding: 10px; background: #000; color: #0f0; font-family: monospace; font-size: 11px; border-radius: 8px; max-height: 200px; overflow: auto; white-space: pre-wrap; display: none; border: 1px solid #333; }
  .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 16px; }
  .time-btns { display: flex; gap: 4px; justify-content: flex-end; margin-bottom: 8px; }
  .time-btns button { font-size: 10px; padding: 2px 8px; border-radius: 4px; }
</style>
</head>
<body>
<header>
  <h1>CL LP Exposure Planner</h1>
  <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('single')">Single LP Planner</button>
      <button class="tab-btn" onclick="switchTab('cross')">Cross-Pair Optimizer</button>
  </div>
</header>

<div class="wrap">
  
  <div id="tab-single" class="tab-content active">
      <div class="card">
        <h2>Inputs
          <span class="pill" style="float:right; background:var(--good); border-color:#1c693b;">
            Live Sheets & CoinGecko PRO
          </span>
        </h2>
        
        <div class="row4" style="margin-top:6px; grid-template-columns:1fr 1fr 2fr;">
          <div>
            <label>Alt asset (Select to load config)</label>
            <select id="assetSelect">
              <option value="">– Select asset –</option>
            </select>
          </div>
          <div>
            <label>Denominated asset</label>
            <select id="denomSelect">
              <option value="BTC" selected>BTC</option>
              <option value="ETH">ETH</option>
              <option value="SOL">SOL</option>
              <option value="BNB">BNB</option>
              <option value="HYPE">HYPE</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <div>
             <div class="footnote" id="sheetStatus" style="margin-top:24px; color:var(--warn);">
               Loading asset list...
             </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px; padding-top:12px; border-top:1px solid #1a2433;">
          <div>
            <label style="color:var(--accent);">Alt Price (USD)</label>
            <input type="number" id="altUsd" step="0.000001" value="0" style="border-color:var(--accent);">
          </div>
          <div>
            <label><span class="denomLabelShort">BTC</span> Price (USD)</label>
            <input type="number" id="denomUsd" step="0.01" value="60000">
          </div>
          <div>
             <label style="color:var(--accent);">JLP Price (USD, for JLP Mode)</label>
             <input type="number" id="jlpUsd" step="0.001" value="0" style="border-color:var(--accent);">
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>Price Min (Pmin, ALT/denom)</label>
            <input type="number" id="pmin" step="0.00000001" value="0.00010000">
          </div>
          <div>
            <label>Price Max (Pmax, ALT/denom)</label>
            <input type="number" id="pmax" step="0.00000001" value="0.00035000">
          </div>
          <div>
            <label>Current Price P₀ (ALT/<span class="denomLabelShort">BTC</span>)
               <span style="color:var(--good); font-weight:bold; margin-left:4px;">(Calculated)</span>
            </label>
            <input type="number" id="p0" step="0.00000001" value="0" style="background:#0c121a; color:var(--ink);">
          </div>
        </div>

        <div class="row4" style="margin-top:12px;">
          <div>
            <label>Total Portfolio size (<span class="denomLabelShort">BTC</span>)</label>
            <input type="number" id="portfolioSize" step="0.0001" value="0">
          </div>
          <div>
            <label>Target net exposure @ Pmin (% of portfolio)</label>
            <input type="number" id="targetMinPct" step="0.01" value="0">
          </div>
          <div>
            <label>Target net exposure @ Pmax (% of portfolio)</label>
            <input type="number" id="targetMaxPct" step="0.01" value="-100">
          </div>
          <div style="display:flex; flex-direction:column; gap:6px;">
             <div class="chk-row">
                <input type="checkbox" id="dualLpMode">
                <label for="dualLpMode" style="margin:0; font-size:12px; color:var(--ink); font-weight:600;">Dual LP</label>
                <input type="number" id="dualMult" step="0.1" value="1.0" style="width:50px; padding:2px 5px; margin-left:8px; border-color:#233142;" title="Multiplier per strategy (0.5 = 50% split, 1.0 = Full Size)">
                <span style="font-size:10px; color:var(--muted)">x</span>
             </div>
             <div class="chk-row">
                <input type="checkbox" id="jlpStrategyMode">
                <label for="jlpStrategyMode" style="margin:0; font-size:12px; color:var(--accent); font-weight:600;">JLP Mode (Hedged)</label>
             </div>
             <div class="chk-row">
                <input type="checkbox" id="tripleLpMode">
                <label for="tripleLpMode" style="margin:0; font-size:12px; color:#e08aff; font-weight:600;">Triple Split (3-Way)</label>
             </div>
          </div>
        </div>

        <div class="row4" style="margin-top:6px;">
          <div>
            <label>Interval size (%)</label>
            <input type="number" id="intervalPct" step="0.01" value="1">
          </div>
          <div style="position:relative;">
            <label>Current Net Exposure (<span class="denomLabelShort">BTC</span>)
              <span class="muted">(ALT + short, before LP)</span>
            </label>
            <div style="display:flex; gap:4px;">
              <input type="number" id="currentE" step="0.0001" value="0" style="flex:1;">
              <span id="fetchIndicator" style="display:none; color:var(--accent); font-size:10px; align-self:center;">Updating...</span>
            </div>
            <div id="fetchStatus" style="font-size:10px; color:var(--warn); margin-top:2px; height:14px;"></div>
          </div>
          <div>
            <label>Target @ Pmin (<span class="denomLabelShort">BTC</span>, auto)</label>
            <input type="number" id="targetMin" step="0.0001" value="0" readonly>
          </div>
          <div>
            <label>Target @ Pmax (<span class="denomLabelShort">BTC</span>, auto)</label>
            <input type="number" id="targetMax" step="0.0001" value="0" readonly>
          </div>
        </div>

        <div class="row4" style="margin-top:6px;">
          <div>
            <label>Precision decimals</label>
            <input type="number" id="dec" step="1" value="4">
          </div>
          <div>
            <label>Distribution Mode</label>
            <select id="distMode">
              <option value="uniform" selected>Equal Units (Linear)</option>
              <option value="univ3">Uni V3 Standard (Single Position)</option>
            </select>
          </div>
          <div>
            <label>Cap rows (optional)</label>
            <input type="number" id="capRows" step="1" placeholder="">
          </div>
          <div>
            <label>Show zero-only rows?</label>
            <select id="showZeros">
              <option value="hide">Hide</option>
              <option value="show">Show</option>
            </select>
          </div>
        </div>
        
        <div class="row4" style="margin-top:6px;">
           <div>
            <label>Assume current exposure scales with price?</label>
            <select id="scaleMode">
              <option value="scale">Scale linearly with price (default)</option>
              <option value="noscale">Do not scale current exposure</option>
            </select>
          </div>
          <div>
            <label style="color:var(--good)">Active % (Below)</label>
            <input type="number" id="activeUtilBelow" step="1" value="10" title="% of Bid Side Capital actively deployed">
          </div>
          <div>
            <label style="color:var(--accent)">Active % (Above)</label>
            <input type="number" id="activeUtilAbove" step="1" value="10" title="% of Ask Side Capital actively deployed">
          </div>
          <div>
            <label>APR on Active Capital (%)</label>
            <input type="number" id="aprPct" step="0.01" value="20">
          </div>
        </div>
        
        <div style="margin-top:12px;">
            <button class="secondary" onclick="toggleDebug()" style="font-size:11px; padding:4px 8px;">Toggle API Debug (Safe)</button>
            <div id="debugBox"></div>
        </div>

        <div class="btns" style="margin-top:12px;">
          <button class="primary" id="btn">Generate Schedules</button>
          <button class="secondary" id="btnExposure" style="color:var(--accent); border-color:var(--accent);">Generate Exposure</button>
          <button class="secondary" id="btnPnL" style="color:var(--good); border-color:var(--good);">Generate PnL</button>
          <div style="flex:1"></div>
          <button class="purple" id="btnCaptureA">Capture Base (A)</button>
          <button class="purple" id="btnCaptureB">Capture Quote (B)</button>
          <button id="btnClear">Clear Tables</button>
        </div>
        <div id="captureStatus" style="font-size:11px; color:var(--purple); margin-top:8px; text-align:right;"></div>
      </div>
      
      <div id="resultsContainer"></div>
  </div>

  <div id="tab-cross" class="tab-content">
      <div class="card" id="crossPairCard">
        <div class="section-header" style="margin-top:0; color:var(--purple); border-bottom-color:var(--purple);">
            Cross-Pair Inventory Bridge
        </div>
        <div class="footnote" style="margin-bottom:12px;">
            1. Go to "Single LP Planner". Load <b>Asset A (e.g. SOL)</b> and click "Capture Base (A)".<br>
            2. Load <b>Asset B (e.g. ETH)</b> and click "Capture Quote (B)".<br>
            3. Return here to calculate the implied +EV strategy for the pair (SOL-ETH).
        </div>
        
        <div class="cp-grid">
            <div class="cp-card" id="cpSlotA">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                    <span class="cp-label">BASE ASSET (A)</span>
                    <span id="cpNameA" style="font-weight:bold; color:var(--ink);">--</span>
                </div>
                <div class="row2">
                    <div><span class="cp-label">Pmin (BTC)</span><div class="cp-val" id="cpMinA">--</div></div>
                    <div><span class="cp-label">Pmax (BTC)</span><div class="cp-val" id="cpMaxA">--</div></div>
                    <div><span class="cp-label">Target Inventory</span><div class="cp-val" id="cpTgtA">--</div></div>
                    <div><span class="cp-label">Current Inventory</span><div class="cp-val" id="cpCurA">--</div></div>
                </div>
            </div>
            <div class="cp-card" id="cpSlotB">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                    <span class="cp-label">QUOTE ASSET (B)</span>
                    <span id="cpNameB" style="font-weight:bold; color:var(--ink);">--</span>
                </div>
                 <div class="row2">
                    <div><span class="cp-label">Pmin (BTC)</span><div class="cp-val" id="cpMinB">--</div></div>
                    <div><span class="cp-label">Pmax (BTC)</span><div class="cp-val" id="cpMaxB">--</div></div>
                    <div><span class="cp-label">Target Inventory</span><div class="cp-val" id="cpTgtB">--</div></div>
                    <div><span class="cp-label">Current Inventory</span><div class="cp-val" id="cpCurB">--</div></div>
                </div>
            </div>
        </div>
        
        <button class="purple" id="btnCalcCross" style="width:100%; font-weight:600; padding:12px;">Calculate Cross-Pair Strategy</button>
        
        <div id="cpResults" style="display:none; margin-top:16px;">
             <div class="summary-box">
                <div class="summary-row">
                     <div class="summary-item"><label>Implied Price</label><div id="resImpPrice" style="color:var(--accent);">--</div></div>
                     <div class="summary-item"><label>Implied Range (Safe)</label><div id="resImpRange">--</div></div>
                     <div class="summary-item"><label>Inventory Gap (USD)</label><div id="resGapUsd">--</div></div>
                     <div class="summary-item"><label>Status</label><div id="resStatus" style="font-weight:bold;">--</div></div>
                </div>
             </div>
             <div class="rec-box" id="recBox"></div>
        </div>
      </div>
  </div>
  
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- START: GOOGLE APPS SCRIPT URL ---
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqG0z2v6nZZZpuhGVYHR28R71jpKl4psheB3bsMQ1bj2Hc4-590l-7Xgj8LUG6cFryMw/exec';
// --- END: GOOGLE APPS SCRIPT URL ---

const COINGECKO_IDS = {
  BTC: 'bitcoin', ETH: 'ethereum', SOL: 'solana', BNB: 'binancecoin',
  ARB: 'arbitrum', OP: 'optimism', TIA: 'celestia', MATIC: 'matic-network',
  LINK: 'chainlink', AVAX: 'avalanche-2', DOGE: 'dogecoin', ADA: 'cardano',
  XRP: 'ripple', LDO: 'lido-dao', UNI: 'uniswap', ASTER: 'aster-2',
  JLP: 'jupiter-perpetuals-liquidity-provider-token', XPL: 'plasma',
  HYPE: 'hyperliquid', 4: '4-2', GIGGLE: 'giggle-fund', USELESS: 'useless-3',
  MET: 'meteora', CAKE: 'pancakeswap', '币安人生': 'bianrensheng',
  SUI: 'sui', APT: 'aptos', ZEC: 'zcash', VIRTUALS: 'virtual-protocol',
  AERO: 'aerodrome-finance', ORE: 'ore', SEI: 'sei', BANK: 'lorenzo-protocol',
  META: 'meta-2', AVICI: 'avici', CLANKER: 'tokenbot-2', AVNT: 'avantis',
  PUMP: 'pump-fun', LINEA: 'linea', S: 'sonic', ZORA: 'zora', MMT: 'momentum-2',
  HIPPO: 'hippo-protocol', FET: 'artificial-superintelligence-alliance',
  CC: 'canton', TAO: 'bittensor', PIGGY: 'piggycell', ZEN: 'horizen',
  MON: 'monad', XDC: 'xdc-network', DOT: 'polkadot', Broccoli: 'czs-dog'
};

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    const btns = document.querySelectorAll('.tab-btn');
    if(tabId === 'single') btns[0].classList.add('active');
    if(tabId === 'cross') btns[1].classList.add('active');
}

function fmt(x, d){
  if(!isFinite(x)) return '–';
  const s = Number(x).toFixed(d);
  return Number(s).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});
}

function toggleDebug() {
    const el = document.getElementById('debugBox');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function updateDenomLabels(sym){
  const s = sym || 'BTC';
  document.querySelectorAll('.denomLabelShort').forEach(el => { el.textContent = s; });
}

// --- SYNC FUNCTIONS (Bi-Directional) ---
function updateP0FromUsd() {
    const altUsd = Number(document.getElementById('altUsd').value || 0);
    const denomUsd = Number(document.getElementById('denomUsd').value || 0);
    const p0El = document.getElementById('p0');
    if(altUsd > 0 && denomUsd > 0) {
        const ratio = altUsd / denomUsd;
        p0El.value = ratio.toFixed(10); 
    }
}

function updateUsdFromP0() {
    const p0 = Number(document.getElementById('p0').value || 0);
    const denomUsd = Number(document.getElementById('denomUsd').value || 0);
    const altUsdEl = document.getElementById('altUsd');
    if(p0 > 0 && denomUsd > 0) {
        const val = p0 * denomUsd;
        altUsdEl.value = val.toFixed(6);
    }
}

function updateAutoTargets() {
    const portSize = Number(document.getElementById('portfolioSize').value) || 0;
    const minPct = Number(document.getElementById('targetMinPct').value) || 0;
    const maxPct = Number(document.getElementById('targetMaxPct').value) || 0;
    const targetMinEl = document.getElementById('targetMin');
    const targetMaxEl = document.getElementById('targetMax');
    const tMin = portSize * (minPct / 100.0);
    const tMax = portSize * (maxPct / 100.0);
    targetMinEl.value = tMin.toFixed(4);
    targetMaxEl.value = tMax.toFixed(4);
}

// --- LIVE EXPOSURE & PRICE FETCHING ---
let fetchTimeout = null;
async function fetchLiveExposure() {
  const assetSym = document.getElementById('assetSelect').value;
  const denomUsd = Number(document.getElementById('denomUsd').value || 0);
  const statusEl = document.getElementById('fetchStatus');
  const currentEEl = document.getElementById('currentE');
  const indEl = document.getElementById('fetchIndicator');

  if(!assetSym || assetSym === "") { statusEl.textContent = ''; return; }
  if(denomUsd <= 0) return;
  if(indEl) indEl.style.display = 'block';
  
  try {
    const res = await fetch('/api/exposure');
    if (!res.ok) throw new Error(`Error ${res.status}`);
    const rawData = await res.json();
    let dataList = [];
    if (Array.isArray(rawData)) { dataList = rawData; } 
    else if (typeof rawData === 'object' && rawData !== null) {
        const keys = Object.keys(rawData);
        if (keys.length > 0 && keys.every(k => k === k.toUpperCase() && k.length < 10)) {
            dataList = keys.map(k => ({ symbol: k, ...rawData[k] }));
        } else if (Array.isArray(rawData.table_data)) { dataList = rawData.table_data;
        } else if (Array.isArray(rawData.data)) dataList = rawData.data;
        else if (Array.isArray(rawData.positions)) dataList = rawData.positions;
        else if (Array.isArray(rawData.result)) dataList = rawData.result;
        else { dataList = [rawData]; }
    }
    const searchSym = assetSym.toUpperCase();
    const found = dataList.find(p => {
        const s1 = (p.symbol || '').toUpperCase();
        const s2 = (p.ticker || '').toUpperCase();
        const s3 = (p.asset || '').toUpperCase();
        const s4 = (p.name || '').toUpperCase(); 
        return s1 === searchSym || s2 === searchSym || s3 === searchSym || s4.includes(searchSym);
    });

    if (found) {
        const usdVal = Number(found.net_exposure_usd_from_base || 0);
        if (!isNaN(usdVal) && usdVal !== 0) {
            const denomExposure = usdVal / denomUsd;
            currentEEl.value = denomExposure.toFixed(6);
            statusEl.textContent = `Auto-Loaded: $${fmt(usdVal, 0)} exposure`;
            statusEl.style.color = 'var(--good)';
            generate();
        } else {
            statusEl.textContent = `Found ${assetSym}, but 0 exposure.`;
            statusEl.style.color = 'var(--warn)';
        }
    } else {
        statusEl.textContent = `No position found for ${assetSym}.`;
        statusEl.style.color = 'var(--muted)';
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = `Fetch failed: ${err.message}`;
    statusEl.style.color = 'var(--bad)';
  } finally {
    if(indEl) indEl.style.display = 'none';
  }
}

function triggerAutoFetch() {
    if(fetchTimeout) clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(fetchLiveExposure, 500); 
}

async function fetchPriceBatch(ids) {
    if(!ids) return {};
    try {
        const url = `/api/price?ids=${encodeURIComponent(ids)}&vs_currencies=usd`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(res.statusText);
        return await res.json();
    } catch(e) { console.warn("Batch fetch failed:", e); return null; }
}

async function autoFetchPrices(assetSym, denomSym){
  const statusEl = document.getElementById('sheetStatus');
  statusEl.textContent = "Fetching prices...";
  statusEl.style.color = 'var(--accent)';

  let assetId = COINGECKO_IDS[(assetSym || '').toUpperCase()];
  if (!assetId && assetSym) { assetId = assetSym.toLowerCase(); }
  const denomId = COINGECKO_IDS[(denomSym || '').toUpperCase()];
  const jlpId   = COINGECKO_IDS['JLP'];
  const isUsd   = (denomSym || '').toUpperCase() === 'USD';

  if(!denomId && !isUsd){ statusEl.textContent = "Waiting for denom asset..."; return false; }

  try {
    if (window.location.protocol === 'file:' || window.location.protocol === 'blob:') {
      statusEl.innerHTML = '<span style="color:var(--warn)">(Live prices require Vercel)</span>';
      return false;
    }
    if (isUsd) { document.getElementById('denomUsd').value = 1; }
    let mainIds = (!isUsd && denomId) ? denomId : '';
    if(assetId) mainIds += (mainIds ? ',' : '') + assetId;
    let mainData = {};
    let success = false;
    if(mainIds) {
        mainData = await fetchPriceBatch(mainIds);
        if(mainData) {
            success = true;
            if(!isUsd && mainData[denomId]?.usd) { document.getElementById('denomUsd').value = mainData[denomId].usd; }
            if(assetId && mainData[assetId]?.usd) { document.getElementById('altUsd').value = mainData[assetId].usd; }
        }
    } else { success = true; }
    if(jlpId) {
        fetchPriceBatch(jlpId).then(jlpData => {
            if(jlpData && jlpData[jlpId]?.usd) { document.getElementById('jlpUsd').value = jlpData[jlpId].usd; }
        });
    }
    if(success) {
        updateP0FromUsd();
        triggerAutoFetch();
        statusEl.textContent = `Prices Updated for ${assetSym}.`;
        statusEl.style.color = 'var(--good)';
        return true;
    } else { throw new Error("Main fetch failed"); }
  } catch(err) {
    console.error('Price Error:', err);
    statusEl.textContent = `Price API Error. Enter Manually.`;
    statusEl.style.color = 'var(--warn)';
    return false;
  }
}

async function loadAssetList(){
  const sel = document.getElementById('assetSelect');
  const statusEl = document.getElementById('sheetStatus');
  if(!sel || !statusEl) { statusEl.innerHTML = '<span style="color:var(--bad)">ERROR:</span> Missing elements.'; return; }
  statusEl.textContent = 'Loading asset list...';
  sel.innerHTML = '<option value="">– Select asset –</option>';
  try{
    const res = await fetch('/api/config');
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if(data.error){ throw new Error(data.error); }
    if(data.assets && Array.isArray(data.assets)){
      data.assets.forEach(sym => {
        if(sym && String(sym).trim() !== ''){
          const opt = document.createElement('option');
          opt.value = String(sym).trim();
          opt.textContent = String(sym).trim();
          sel.appendChild(opt);
        }
      });
      statusEl.textContent = `Loaded ${data.assets.length} assets.`;
    } else { statusEl.textContent = 'No assets found.'; }
  }catch(err){
    console.error('Error loading asset list', err);
    statusEl.innerHTML = `<span style="color:var(--bad)">ERROR:</span> Failed to load list: ${err.message}`;
  }
}

async function loadAssetConfig(symbol){
  if(!symbol) return;
  const statusEl = document.getElementById('sheetStatus');
  statusEl.textContent = `Loading config for ${symbol}...`;
  try{
    const [configRes, portfolioRes] = await Promise.all([
      fetch(`${APPS_SCRIPT_URL}?symbol=${encodeURIComponent(symbol)}`),
      fetch('/api/portfolio-size')
    ]);
    if(!configRes.ok) throw new Error(`Config HTTP ${configRes.status}`);
    const data = await configRes.json();
    if(data.error) throw new Error(data.error);
    let portfolioSizeUsd = null;
    if(portfolioRes.ok) {
      const portfolioData = await portfolioRes.json();
      if(portfolioData.error) { console.warn('Portfolio size API error:', portfolioData.error); } 
      else if(typeof portfolioData.portfolioSize === 'number') { portfolioSizeUsd = portfolioData.portfolioSize; }
    }
    if(typeof data.pmin === 'number') document.getElementById('pmin').value = data.pmin;
    if(typeof data.pmax === 'number') document.getElementById('pmax').value = data.pmax;
    if(typeof data.targetMinPct === 'number') document.getElementById('targetMinPct').value = data.targetMinPct;
    if(typeof data.targetMaxPct === 'number') document.getElementById('targetMaxPct').value = data.targetMaxPct;
    let denomSym = 'BTC';
    if(data.denomAsset){
      const dSel = document.getElementById('denomSelect');
      if(dSel){ dSel.value = data.denomAsset; updateDenomLabels(data.denomAsset); denomSym = data.denomAsset; }
    }
    const success = await autoFetchPrices(symbol, denomSym);
    if(portfolioSizeUsd !== null) {
      const denomUsd = Number(document.getElementById('denomUsd').value || 0);
      if(denomUsd > 0) {
        const portfolioSizeInDenom = portfolioSizeUsd / denomUsd;
        document.getElementById('portfolioSize').value = portfolioSizeInDenom.toFixed(6);
      }
    }
    const currentAlt = Number(document.getElementById('altUsd').value || 0);
    if((!success || currentAlt === 0) && typeof data.p0 === 'number') { document.getElementById('p0').value = data.p0; updateUsdFromP0(); }
    updateAutoTargets();
    fetchLiveExposure();
    generate();
  }catch(err){
    console.error('Error loading config', err);
    statusEl.innerHTML = `<span style="color:var(--bad)">ERROR:</span> Failed to load ${symbol}: ${err.message}`;
  }
}

// --- CORE CALCULATION LOGIC ---
function buildBands(pmin, pmax, p0, stepPct){
  const down = [], up = [];
  let p = p0;
  while(p > pmin){
    const pb = p;
    const pa = Math.max(pmin, pb * (1 - stepPct/100));
    down.push({pa, pb, type:'Below'});
    if(pa === pmin) break;
    p = pa;
  }
  p = p0;
  while(p < pmax){
    const pa = p;
    const pb = Math.min(pmax, pa * (1 + stepPct/100));
    up.push({pa, pb, type:'Above'});
    if(pb === pmax) break;
    p = pb;
  }
  return {down, up};
}

function calculateStrategy(params, manualBands) {
  const {
    pmin, pmax, p0, stepPct, portfolioSize, targetMinPct, targetMaxPct, currentE,
    denomSymbol, denomUsd, assetSymbol, scaleMode, aprPct, maxDays, distMode
  } = params;
  if(!manualBands && !(pmin>0 && pmax>pmin && p0>0)) return null;
  let bands = manualBands;
  if (!bands) { bands = buildBands(pmin, pmax, p0, stepPct); }
  const Ndown = bands.down.length, Nup = bands.up.length;
  const targetMin = portfolioSize * targetMinPct / 100;
  const targetMax = portfolioSize * targetMaxPct / 100;
  const scaleFactorAt = (px) => (scaleMode === 'scale' && p0 > 0) ? (px/p0) : 1;
  const effectivePmin = (pmin > 0) ? pmin : (bands.down.length > 0 ? bands.down[bands.down.length-1].pa : 0);
  const currentAtMin = currentE * scaleFactorAt(effectivePmin);
  const needMinDelta = (targetMin - currentAtMin); 
  const effectivePmax = (pmax > 0) ? pmax : (bands.up.length > 0 ? bands.up[bands.up.length-1].pb : 0);
  const currentAtMax = currentE * scaleFactorAt(effectivePmax);
  const needMoreNegativeAtMax = currentAtMax - targetMax; 
  
  let aboveTotalScheduled = 0, constUnitsAbove = 0, globalL_Above = 0; 
  if (Nup > 0) {
      if (distMode === 'univ3') {
          const totalAssetUnitsNeeded = needMoreNegativeAtMax / effectivePmax;
          const term = (1/Math.sqrt(p0)) - (1/Math.sqrt(effectivePmax));
          if(term > 0) globalL_Above = totalAssetUnitsNeeded / term;
          aboveTotalScheduled = totalAssetUnitsNeeded * p0;
      } else {
          let sumSqrtP = 0;
          for(const b of bands.up) sumSqrtP += Math.sqrt(b.pa * b.pb);
          constUnitsAbove = sumSqrtP > 0 ? (needMoreNegativeAtMax / sumSqrtP) : 0;
          for(const b of bands.up) aboveTotalScheduled += constUnitsAbove * Math.sqrt(b.pa * b.pb);
      }
  }
  let globalL_Below = 0;
  if(Ndown > 0 && distMode === 'univ3') {
      const term = Math.sqrt(p0) - Math.sqrt(effectivePmin);
      if(term > 0) globalL_Below = needMinDelta / term;
  }
  let holdingsAvail = Math.max(currentE, 0);
  let buyShortAllowed = (targetMax < 0);
  let holdingsUsed = 0;
  let totalReq = aboveTotalScheduled; 
  if(distMode === 'univ3' && Nup > 0){
      totalReq = 0;
      for(const b of bands.up){
          const x_band = globalL_Above * (1/Math.sqrt(b.pa) - 1/Math.sqrt(b.pb));
          totalReq += x_band * Math.sqrt(b.pa * b.pb);
      }
  }
  if(currentE > 0 && targetMax === 0){
    holdingsUsed = Math.min(totalReq, holdingsAvail);
    if(holdingsUsed < totalReq && !buyShortAllowed) totalReq = holdingsUsed; 
  } else {
    holdingsUsed = Math.min(holdingsAvail, totalReq);
    if(!buyShortAllowed){ totalReq = holdingsUsed; }
  }
  let ratio = (aboveTotalScheduled > 0) ? (totalReq / aboveTotalScheduled) : 0;
  if(distMode === 'univ3' && Nup > 0) {
      let rawSum = 0;
      for(const b of bands.up) {
           const x_band = globalL_Above * (1/Math.sqrt(b.pa) - 1/Math.sqrt(b.pb));
           rawSum += x_band * Math.sqrt(b.pa * b.pb);
      }
      ratio = rawSum > 0 ? totalReq / rawSum : 0;
      globalL_Above *= ratio;
  } else { constUnitsAbove *= ratio; }

  let sumRdown = 0;
  for(const b of bands.down) sumRdown += Math.sqrt(b.pa / b.pb); 
  let perUsdBelow = 0;
  if(distMode !== 'univ3'){
      for(const b of bands.down){ b.r_down = Math.sqrt(b.pa / b.pb); }
      sumRdown = 0; 
      for(const b of bands.down) sumRdown += b.r_down;
      perUsdBelow = sumRdown>0 ? (needMinDelta / sumRdown) : 0;
  }
  const rows = [];
  const ordered = [...bands.down, ...bands.up];
  let belowTotal = 0, cumBelowValue = 0, cumAboveSale = 0;
  let holdingsRemaining = holdingsUsed;
  let aboveTotal = 0;
  ordered.forEach((b, idx) => {
    const isDown = (b.type === 'Below');
    const rdown = isDown ? b.r_down : 0;
    const boundaryPx = isDown ? b.pa : b.pb;
    let deployUSD = 0, valueAtPa = 0, deployAltUsd = 0, saleAtPb = 0, sourceTag = '', altUnitsAbove = 0;
    if(isDown){
      if(distMode === 'univ3') { deployUSD = globalL_Below * (Math.sqrt(b.pb) - Math.sqrt(b.pa)); } 
      else { deployUSD = perUsdBelow; }
      valueAtPa = deployUSD * rdown; // approx
      belowTotal += deployUSD;
      cumBelowValue += valueAtPa;
    } else {
       if (distMode === 'univ3') {
          const x_band = globalL_Above * (1/Math.sqrt(b.pa) - 1/Math.sqrt(b.pb));
          altUnitsAbove = x_band;
          deployAltUsd = x_band * Math.sqrt(b.pa * b.pb);
       } else {
          altUnitsAbove = constUnitsAbove;
          deployAltUsd = altUnitsAbove * Math.sqrt(b.pa * b.pb);
       }
       if(aboveTotal < totalReq - 1e-12){
          aboveTotal += deployAltUsd;
          let useHold = 0;
          if(holdingsRemaining > 0){
            useHold = Math.min(deployAltUsd, holdingsRemaining);
            holdingsRemaining -= useHold;
            sourceTag = '<span class="tag hold">Holdings</span>';
          } else { sourceTag = '<span class="tag source">Buy+Short</span>'; }
       }
    }
    const baseE = currentE * scaleFactorAt(boundaryPx);
    const netAtBoundary = isDown ? (baseE + cumBelowValue) : (baseE - cumAboveSale);
    rows.push({
      bandIdx: b.origIdx || (idx + 1), pa: b.pa, pb: b.pb, type: b.type,
      deployUSD, deployAltUsd, sourceTag, altUnitsAbove: (!isDown) ? altUnitsAbove : 0, netAtBoundary
    });
  });
  return { rows, kpi: { Ndown, Nup, belowTotal, aboveTotal: totalReq }, rawBands: bands };
}

function renderLPSection(container, title, strategyData, denomSymbol, denomUsd, assetSymbol, lpId) {
  if(!strategyData) return;
  const { rows } = strategyData;
  rows.sort((a, b) => a.pa - b.pa);
  let aboveAssetSum = 0, belowQuoteSum = 0, aboveDenomSum = 0, belowDenomSum = 0;
  rows.forEach(r => {
      if(r.type === 'Above') { aboveAssetSum += r.altUnitsAbove; aboveDenomSum += r.deployAltUsd; }
      if(r.type === 'Below') { belowQuoteSum += r.deployUSD; belowDenomSum += r.deployUSD; }
  });
  const totalUsdAbove = aboveDenomSum * denomUsd;
  const totalUsdBelow = belowDenomSum * denomUsd;

  const sectionHtml = `
    <div class="section-header">${title}</div>
    <div class="summary-box">
       <div class="summary-row">
          <div class="summary-item"><label>Total ${assetSymbol} Above</label><div>${fmt(aboveAssetSum, 4)}</div></div>
          <div class="summary-item"><label>Total USD Above</label><div>$${fmt(totalUsdAbove, 2)}</div></div>
          <div class="summary-item"><label>Total ${denomSymbol} Below</label><div>${fmt(belowQuoteSum, 4)}</div></div>
          <div class="summary-item"><label>Total USD Below</label><div>$${fmt(totalUsdBelow, 2)}</div></div>
       </div>
    </div>
    <div class="card"><div class="scroll"><table><thead><tr>
        <th style="text-align:left;">Band</th><th>Range (p<sub>a</sub> - p<sub>b</sub>)</th><th>Type</th><th>Deployed Asset</th><th>Value (USD)</th>
    </tr></thead><tbody>
    ${rows.map(r => {
        if((document.getElementById('showZeros').value!=='show') && (r.deployUSD + r.deployAltUsd < 1e-12)) return '';
        let deployStr = '', usdVal = 0, color = '';
        if (r.type === 'Below') { deployStr = fmt(r.deployUSD, 6) + ' ' + denomSymbol; usdVal = r.deployUSD * denomUsd; color = 'var(--good)'; } 
        else { deployStr = fmt(r.altUnitsAbove, 6) + ' ' + assetSymbol; usdVal = r.deployAltUsd * denomUsd; color = 'var(--accent)'; }
        return `<tr><td style="text-align:left">${r.bandIdx}</td><td>${fmt(r.pa, 6)} - ${fmt(r.pb, 6)}</td><td style="color:${color}">${r.type === 'Below' ? '↓' : '↑'}</td><td style="font-weight:600; color:${color}">${deployStr}</td><td style="color:#888">$${fmt(usdVal, 2)}</td></tr>`;
    }).join('')}
    </tbody></table></div></div>
  `;
  const div = document.createElement('div');
  div.id = 'section_' + lpId;
  div.innerHTML = sectionHtml;
  container.appendChild(div);
}

function getUnitsHeldAt(px, pmin, pmax, portSize, tMinPct, tMaxPct, mode) {
    const valMin = portSize * (tMinPct / 100);
    const valMax = portSize * (tMaxPct / 100);
    const uMin = valMin / pmin;
    const uMax = valMax / pmax;
    const p = Math.max(pmin, Math.min(px, pmax));
    if (mode === 'uniform') {
        const progress = (p - pmin) / (pmax - pmin);
        const currentTargetVal = valMin + (valMax - valMin) * progress;
        return currentTargetVal / p;
    } else if (mode === 'univ3') {
        const deltaU = uMin - uMax;
        if(Math.abs(pmax - pmin) < 1e-9) return uMin;
        const invSqrtMin = 1/Math.sqrt(pmin);
        const invSqrtMax = 1/Math.sqrt(pmax);
        const L = deltaU / (invSqrtMin - invSqrtMax);
        return L * (1/Math.sqrt(p) - 1/Math.sqrt(pmax)) + uMax;
    }
    return uMin;
}

function generate() {
  const container = document.getElementById('resultsContainer');
  container.innerHTML = '';
  const pmin = Number(document.getElementById('pmin').value);
  const pmax = Number(document.getElementById('pmax').value);
  const p0 = Number(document.getElementById('p0').value);
  const stepPct = Number(document.getElementById('intervalPct').value);
  const portfolioSize = Number(document.getElementById('portfolioSize').value);
  const currentE = Number(document.getElementById('currentE').value);
  const targetMinPct = Number(document.getElementById('targetMinPct').value);
  const targetMaxPct = Number(document.getElementById('targetMaxPct').value);
  const distMode = document.getElementById('distMode').value;
  const isDual = document.getElementById('dualLpMode').checked;
  const isJlpMode = document.getElementById('jlpStrategyMode').checked;
  
  const strategies = [];
  let capitalRatio = isDual ? (Number(document.getElementById('dualMult').value) || 0.5) : (isJlpMode ? 0.5 : 1.0);
  const assetSymbol = (document.getElementById('assetSelect').value || 'ALT').toUpperCase();
  const denomSymbol = (document.getElementById('denomSelect').value || 'BTC').toUpperCase();
  
  const baseParams = { pmin, pmax, p0, stepPct, portfolioSize: portfolioSize * capitalRatio, currentE: currentE * capitalRatio, targetMinPct, targetMaxPct, denomSymbol, denomUsd: Number(document.getElementById('denomUsd').value), assetSymbol, scaleMode: document.getElementById('scaleMode').value, aprPct: 0, maxDays: 0, distMode };
  strategies.push({ title: isDual?`LP 1 (${capitalRatio}x)`:`Schedule`, id: 'lp1', params: baseParams });
     
  if(isDual) {
        const usdPmin = pmin * baseParams.denomUsd, usdPmax = pmax * baseParams.denomUsd, usdP0 = p0 * baseParams.denomUsd;
        strategies.push({ title: `LP 2 (USD, ${capitalRatio}x)`, id: 'lp2', params: { ...baseParams, pmin: usdPmin, pmax: usdPmax, p0: usdP0, portfolioSize: portfolioSize * baseParams.denomUsd * capitalRatio, currentE: currentE * baseParams.denomUsd * capitalRatio, denomSymbol: 'USD', denomUsd: 1 } });
  }
  
  strategies.forEach(s => { if(!s.data) s.data = calculateStrategy(s.params); });
  strategies.forEach(s => renderLPSection(container, s.title, s.data, s.params.denomSymbol, s.params.denomUsd, s.params.assetSymbol, s.id));
}

// --- UPDATED CROSS PAIR OPTIMIZER LOGIC (Core + Overflow + Tight) ---
const crossState = { A: null, B: null };

function captureSnapshot(slot) {
    const asset = document.getElementById('assetSelect').value || 'Asset';
    const denom = document.getElementById('denomSelect').value || 'BTC';
    const pmin = Number(document.getElementById('pmin').value);
    const pmax = Number(document.getElementById('pmax').value);
    const p0 = Number(document.getElementById('p0').value);
    const portSize = Number(document.getElementById('portfolioSize').value);
    const tMinPct = Number(document.getElementById('targetMinPct').value);
    const tMaxPct = Number(document.getElementById('targetMaxPct').value);
    const curExp = Number(document.getElementById('currentE').value);
    const denomUsd = Number(document.getElementById('denomUsd').value) || 1;
    const distMode = document.getElementById('distMode').value;
    
    // Calculate Target at current price
    const targetUnitsCurrent = getUnitsHeldAt(p0, pmin, pmax, portSize, tMinPct, tMaxPct, distMode);
    const targetValUsd = targetUnitsCurrent * p0 * denomUsd; 
    const curValUsd = curExp * denomUsd;

    const snap = {
        name: asset,
        pmin, pmax, p0, denom, denomUsd,
        targetValUsd, curValUsd, targetUnitsCurrent, curExp
    };

    crossState[slot] = snap;
    renderCrossCard(slot);
    const statusDiv = document.getElementById('captureStatus');
    statusDiv.innerText = `Captured ${asset} as ${slot === 'A' ? 'Base (A)' : 'Quote (B)'} ✓`;
    setTimeout(() => { statusDiv.innerText = ''; }, 3000);
}

function renderCrossCard(slot) {
    const s = crossState[slot];
    if(!s) return;
    document.getElementById(`cpName${slot}`).innerText = s.name;
    document.getElementById(`cpMin${slot}`).innerText = fmt(s.pmin, 6);
    document.getElementById(`cpMax${slot}`).innerText = fmt(s.pmax, 6);
    document.getElementById(`cpTgt${slot}`).innerText = `$${fmt(s.targetValUsd, 0)}`;
    const curEl = document.getElementById(`cpCur${slot}`);
    curEl.innerText = `$${fmt(s.curValUsd, 0)}`;
    const diff = s.curValUsd - s.targetValUsd;
    if(diff < -100) curEl.style.color = 'var(--warn)';
    else if(diff > 100) curEl.style.color = 'var(--accent)';
    else curEl.style.color = 'var(--ink)';
}

function calculateCrossPair() {
    if(!crossState.A || !crossState.B) { alert("Please capture both Asset A (Base) and Asset B (Quote) first."); return; }
    
    const A = crossState.A; 
    const B = crossState.B; 
    const impPrice = A.p0 / B.p0;
    const impMin = A.pmin / B.pmax;
    const impMax = A.pmax / B.pmin;
    
    const gapA_USD = A.curValUsd - A.targetValUsd; 
    const gapB_USD = B.curValUsd - B.targetValUsd; 
    
    const resBox = document.getElementById('cpResults');
    resBox.style.display = 'block';
    document.getElementById('resImpPrice').innerText = fmt(impPrice, 6) + ` ${B.name}`;
    document.getElementById('resImpRange').innerText = `${fmt(impMin, 5)} - ${fmt(impMax, 5)}`;
    
    const gapStrA = gapA_USD > 0 ? `+${fmt(gapA_USD,0)}` : fmt(gapA_USD,0);
    const gapStrB = gapB_USD > 0 ? `+${fmt(gapB_USD,0)}` : fmt(gapB_USD,0);
    document.getElementById('resGapUsd').innerText = `${A.name}:${gapStrA} / ${B.name}:${gapStrB}`;
    
    let statusMsg = "", recHtml = "";

    // LOGIC FIX: Handle Double Surplus (Heavy Base/Heavy Quote)
    if (gapA_USD > 100 && gapB_USD > 100) {
        // Both are Surplus. Identify Ratio.
        const ratio = gapA_USD / gapB_USD;
        
        if (ratio > 2.0) {
            // HEAVY BASE SURPLUS
            statusMsg = `Skewed Surplus (Heavy ${A.name})`;
            document.getElementById('resStatus').style.color = 'var(--accent)';
            // Core is limited by B
            const coreValB = gapB_USD; 
            const excessValA = gapA_USD - gapB_USD;
            // TIGHT RANGE (Rebalance)
            const overflowTop = impPrice * 1.01; // 1% range for rapid fill

            recHtml = `<div style="color:#fff; font-weight:bold; margin-bottom:4px;">Strategy: Core LP + Concentrated Sell</div>
            <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Excess ${A.name} found. Recommendation: "Limit Sell" via tight CL range.</div>
            <div style="background:#0e1621; padding:10px; border-radius:4px; font-family:monospace; margin-bottom:6px;">
               <span style="color:var(--good)">1. Core Position (Balanced):</span><br>
               Use all ${B.name} ($${fmt(coreValB,0)}) + Matching ${A.name} ($${fmt(coreValB,0)})<br>
               Range: ${fmt(impMin, 5)} - ${fmt(impMax, 5)} (Safe Implied)
            </div>
            <div style="background:#0e1621; padding:10px; border-radius:4px; font-family:monospace;">
               <span style="color:var(--accent)">2. Overflow Position (Ask-Side):</span><br>
               Deploy remaining ${A.name} ($${fmt(excessValA,0)})<br>
               Range: ${fmt(impPrice, 5)} - ${fmt(overflowTop, 5)} (Tight 1%)<br>
               <span style="color:#666; font-size:10px;">*Replaces limit order. Sells immediately if price ticks up.</span>
            </div>`;
        } else if (ratio < 0.5) {
             // HEAVY QUOTE SURPLUS
             statusMsg = `Skewed Surplus (Heavy ${B.name})`;
             document.getElementById('resStatus').style.color = 'var(--good)';
             const coreValA = gapA_USD;
             const excessValB = gapB_USD - gapA_USD;
             const overflowBot = impPrice * 0.99; // 1% range down

             recHtml = `<div style="color:#fff; font-weight:bold; margin-bottom:4px;">Strategy: Core LP + Concentrated Buy</div>
             <div style="background:#0e1621; padding:10px; border-radius:4px; font-family:monospace; margin-bottom:6px;">
               <span style="color:var(--good)">1. Core Position:</span> Use all ${A.name} ($${fmt(coreValA,0)}) + Matching ${B.name} ($${fmt(coreValA,0)}). Range: ${fmt(impMin, 5)} - ${fmt(impMax, 5)}
             </div>
             <div style="background:#0e1621; padding:10px; border-radius:4px; font-family:monospace;">
               <span style="color:var(--good)">2. Overflow Position (Bid-Side):</span><br>
               Deploy remaining ${B.name} ($${fmt(excessValB,0)})<br>
               Range: ${fmt(overflowBot, 5)} - ${fmt(impPrice, 5)} (Tight 1%)
             </div>`;
        } else {
             // BALANCED SURPLUS
             statusMsg = "Balanced Surplus (Double Sided)";
             document.getElementById('resStatus').style.color = '#fff';
             recHtml = `<div style="color:var(--muted); font-size:12px;">You have excess of both assets in relatively equal value. Deploy a standard wide-range LP to capture fees on this inventory.</div>
             <div style="background:#000; padding:8px; border-radius:4px; font-family:monospace; margin-top:6px;">
               Range: ${fmt(impMin, 5)} - ${fmt(impMax, 5)}
             </div>`;
        }
    }
    // STANDARD SCENARIOS (One Surplus, One Deficit)
    else if(gapA_USD < -100 && gapB_USD > 100) {
        statusMsg = `Short ${A.name} / Long ${B.name} (Rebalance)`;
        document.getElementById('resStatus').style.color = 'var(--good)';
        const surplusB_Units = gapB_USD / (B.p0 * B.denomUsd);
        const rangeTop = impPrice * 0.999;
        const rangeBot = impMin; // Can stay wide or tighten based on preference
        recHtml = `<div style="color:#fff; font-weight:bold; margin-bottom:4px;">Strategy: Bid-Side LP (Inventory Capture)</div>
        <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Deploy ${B.name} below price to buy ${A.name} on dips.</div>
        <div style="background:#000; padding:8px; border-radius:4px; font-family:monospace; color:var(--good);">
           Deposit ONLY ${B.name} ${fmt(surplusB_Units, 4)} ($${fmt(gapB_USD, 0)})<br>
           Range: ${fmt(rangeBot, 5)} - ${fmt(rangeTop, 5)}
        </div>`;
    } 
    else if(gapA_USD > 100 && gapB_USD < -100) {
        statusMsg = `Long ${A.name} / Short ${B.name} (Rebalance)`;
        document.getElementById('resStatus').style.color = 'var(--accent)';
        const surplusA_Units = gapA_USD / (A.p0 * A.denomUsd);
        const rangeBot = impPrice * 1.001; 
        const rangeTop = impMax;
        recHtml = `<div style="color:#fff; font-weight:bold; margin-bottom:4px;">Strategy: Ask-Side LP (Distribution)</div>
        <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Deploy ${A.name} above price to sell ${A.name} on pumps.</div>
        <div style="background:#000; padding:8px; border-radius:4px; font-family:monospace; color:var(--accent);">
           Deposit ONLY ${A.name} ${fmt(surplusA_Units, 4)} ($${fmt(gapA_USD, 0)})<br>
           Range: ${fmt(rangeBot, 5)} - ${fmt(rangeTop, 5)}
        </div>`;
    }
    else {
        statusMsg = "Balanced / Neutral";
        document.getElementById('resStatus').style.color = 'var(--muted)';
        recHtml = `<div style="color:var(--muted); font-size:12px;">Inventory is relatively balanced. No directional urgency.</div>`;
    }
    
    document.getElementById('resStatus').innerText = statusMsg;
    document.getElementById('recBox').innerHTML = recHtml;
}

(function(){
  const assetSel = document.getElementById('assetSelect'), denomSel = document.getElementById('denomSelect');
  const altUsdEl = document.getElementById('altUsd'), denomUsdEl = document.getElementById('denomUsd'), p0El = document.getElementById('p0');
  
  if(document.getElementById('btn')) document.getElementById('btn').addEventListener('click', generate);
  document.getElementById('btnCaptureA').addEventListener('click', () => captureSnapshot('A'));
  document.getElementById('btnCaptureB').addEventListener('click', () => captureSnapshot('B'));
  document.getElementById('btnCalcCross').addEventListener('click', calculateCrossPair);
  if(document.getElementById('btnClear')) document.getElementById('btnClear').addEventListener('click', function(){ document.getElementById('resultsContainer').innerHTML = ''; });

  if(altUsdEl) altUsdEl.addEventListener('input', updateP0FromUsd);
  if(denomUsdEl) denomUsdEl.addEventListener('input', updateP0FromUsd);
  if(p0El) p0El.addEventListener('input', updateUsdFromP0);
  if (assetSel) assetSel.addEventListener('change', () => loadAssetConfig(assetSel.value));
  if (denomSel) denomSel.addEventListener('change', () => {
      updateDenomLabels(denomSel.value);
      autoFetchPrices(assetSel ? assetSel.value : '', denomSel.value);
  });
  ['portfolioSize', 'targetMinPct', 'targetMaxPct'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener('input', updateAutoTargets);
  });
  loadAssetList();
  if (denomSel) autoFetchPrices('', denomSel.value);
})();
</script>
</body>
</html>
